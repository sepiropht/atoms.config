'use babel';

function computeDiff(oldText, newText, isWhitespaceIgnored) {
  var _computeDiffChunks2 = _computeDiffChunks(oldText, newText, isWhitespaceIgnored);

  var addedLines = _computeDiffChunks2.addedLines;
  var removedLines = _computeDiffChunks2.removedLines;
  var chunks = _computeDiffChunks2.chunks;

  var _computeOffsets2 = _computeOffsets(chunks);

  var oldLineOffsets = _computeOffsets2.oldLineOffsets;
  var newLineOffsets = _computeOffsets2.newLineOffsets;

  return {
    addedLines: addedLines,
    removedLines: removedLines,
    oldLineOffsets: oldLineOffsets,
    newLineOffsets: newLineOffsets,
    chunks: chunks
  };
}

function _computeDiffChunks(oldText, newText, isWhitespaceIgnored) {

  var JsDiff = require('diff');

  // If the last line has changes, JsDiff doesn't return that.
  // Generally, content with new line ending are easier to calculate offsets for.
  if (oldText[oldText.length - 1] !== '\n' || newText[newText.length - 1] !== '\n') {
    oldText += '\n';
    newText += '\n';
  }

  var lineDiff = JsDiff.diffLines(oldText, newText, { ignoreWhitespace: isWhitespaceIgnored });
  var chunks = [];

  var addedCount = 0;
  var removedCount = 0;
  var nextOffset = 0;
  var offset = 0;

  var addedLines = [];
  var removedLines = [];
  lineDiff.forEach(function (part) {
    var added = part.added;
    var removed = part.removed;
    var value = part.value;

    var count = value.split('\n').length - 1;
    if (!added && !removed) {
      addedCount += count;
      removedCount += count;
      offset = nextOffset;
      nextOffset = 0;
    } else if (added) {
      for (var i = 0; i < count; i++) {
        addedLines.push(addedCount + i);
      }
      addedCount += count;
      nextOffset += count;
    } else {
      for (var i = 0; i < count; i++) {
        removedLines.push(removedCount + i);
      }
      removedCount += count;
      nextOffset -= count;
    }
    chunks.push({ added: added, removed: removed, value: value, count: count, offset: offset });
    offset = 0;
  });
  return { addedLines: addedLines, removedLines: removedLines, chunks: chunks };
}

function _computeOffsets(diffChunks) {
  var newLineOffsets = {};
  var oldLineOffsets = {};

  var oldLineCount = 0;
  var newLineCount = 0;

  for (var chunk of diffChunks) {
    var added = chunk.added;
    var removed = chunk.removed;
    var offset = chunk.offset;
    var count = chunk.count;

    if (added) {
      newLineCount += count;
    } else if (removed) {
      oldLineCount += count;
    } else {
      if (offset < 0) {
        // Non zero offset implies this block is neither a removal or an addition,
        // and is thus equal in both versions of the document.
        // Sign of offset indicates which version of document requires the offset
        // (negative -> old version, positive -> new version).
        // Magnitude of offset indicates the number of lines of offset required for respective version.
        newLineOffsets[newLineCount] = offset * -1;
      } else if (offset > 0) {
        oldLineOffsets[oldLineCount] = offset;
      }
      newLineCount += count;
      oldLineCount += count;
    }
  }

  return {
    oldLineOffsets: oldLineOffsets,
    newLineOffsets: newLineOffsets
  };
}

module.exports = {
  computeDiff: computeDiff
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3dpbGxpYW0vLmF0b20vcGFja2FnZXMvZ2l0LXRpbWUtbWFjaGluZS9ub2RlX21vZHVsZXMvc3BsaXQtZGlmZi9saWIvc3BsaXQtZGlmZi1jb21wdXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7QUFlWixTQUFTLFdBQVcsQ0FBQyxPQUFlLEVBQUUsT0FBZSxFQUFFLG1CQUE0QixFQUFZOzRCQUNwRCxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixDQUFDOztNQUE3RixVQUFVLHVCQUFWLFVBQVU7TUFBRSxZQUFZLHVCQUFaLFlBQVk7TUFBRSxNQUFNLHVCQUFOLE1BQU07O3lCQUNFLGVBQWUsQ0FBQyxNQUFNLENBQUM7O01BQXpELGNBQWMsb0JBQWQsY0FBYztNQUFFLGNBQWMsb0JBQWQsY0FBYzs7QUFFbkMsU0FBTztBQUNMLGNBQVUsRUFBVixVQUFVO0FBQ1YsZ0JBQVksRUFBWixZQUFZO0FBQ1osa0JBQWMsRUFBZCxjQUFjO0FBQ2Qsa0JBQWMsRUFBZCxjQUFjO0FBQ2QsVUFBTSxFQUFOLE1BQU07R0FDUCxDQUFDO0NBQ0g7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxPQUFlLEVBQUUsT0FBZSxFQUFFLG1CQUE0QixFQUFhOztBQUVyRyxNQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7Ozs7QUFJN0IsTUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxFQUFFO0FBQ2hGLFdBQU8sSUFBSSxJQUFJLENBQUM7QUFDaEIsV0FBTyxJQUFJLElBQUksQ0FBQztHQUNqQjs7QUFFRCxNQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBQyxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBQyxDQUFDLENBQUM7QUFDM0YsTUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDOztBQUVoQixNQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7QUFDbkIsTUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLE1BQUksVUFBVSxHQUFHLENBQUMsQ0FBQztBQUNuQixNQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7O0FBRWYsTUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLE1BQUksWUFBWSxHQUFHLEVBQUUsQ0FBQztBQUN0QixVQUFRLENBQUMsT0FBTyxDQUFDLFVBQUEsSUFBSSxFQUFJO1FBQ2xCLEtBQUssR0FBb0IsSUFBSSxDQUE3QixLQUFLO1FBQUUsT0FBTyxHQUFXLElBQUksQ0FBdEIsT0FBTztRQUFFLEtBQUssR0FBSSxJQUFJLENBQWIsS0FBSzs7QUFDMUIsUUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3pDLFFBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxPQUFPLEVBQUU7QUFDdEIsZ0JBQVUsSUFBSSxLQUFLLENBQUM7QUFDcEIsa0JBQVksSUFBSSxLQUFLLENBQUM7QUFDdEIsWUFBTSxHQUFHLFVBQVUsQ0FBQztBQUNwQixnQkFBVSxHQUFHLENBQUMsQ0FBQztLQUNoQixNQUFNLElBQUksS0FBSyxFQUFFO0FBQ2hCLFdBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDOUIsa0JBQVUsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO09BQ2pDO0FBQ0QsZ0JBQVUsSUFBSSxLQUFLLENBQUM7QUFDcEIsZ0JBQVUsSUFBSSxLQUFLLENBQUM7S0FDckIsTUFBTTtBQUNMLFdBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDOUIsb0JBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDO09BQ3JDO0FBQ0Qsa0JBQVksSUFBSSxLQUFLLENBQUM7QUFDdEIsZ0JBQVUsSUFBSSxLQUFLLENBQUM7S0FDckI7QUFDRCxVQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsS0FBSyxFQUFMLEtBQUssRUFBRSxPQUFPLEVBQVAsT0FBTyxFQUFFLEtBQUssRUFBTCxLQUFLLEVBQUUsS0FBSyxFQUFMLEtBQUssRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFDLENBQUMsQ0FBQztBQUNwRCxVQUFNLEdBQUcsQ0FBQyxDQUFDO0dBQ1osQ0FBQyxDQUFDO0FBQ0gsU0FBTyxFQUFDLFVBQVUsRUFBVixVQUFVLEVBQUUsWUFBWSxFQUFaLFlBQVksRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFDLENBQUM7Q0FDM0M7O0FBRUQsU0FBUyxlQUFlLENBQUMsVUFBc0IsRUFBK0M7QUFDNUYsTUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLE1BQUksY0FBYyxHQUFHLEVBQUUsQ0FBQzs7QUFFeEIsTUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLE1BQUksWUFBWSxHQUFHLENBQUMsQ0FBQzs7QUFFckIsT0FBSyxJQUFJLEtBQUssSUFBSSxVQUFVLEVBQUU7UUFDdkIsS0FBSyxHQUE0QixLQUFLLENBQXRDLEtBQUs7UUFBRSxPQUFPLEdBQW1CLEtBQUssQ0FBL0IsT0FBTztRQUFFLE1BQU0sR0FBVyxLQUFLLENBQXRCLE1BQU07UUFBRSxLQUFLLEdBQUksS0FBSyxDQUFkLEtBQUs7O0FBQ2xDLFFBQUksS0FBSyxFQUFFO0FBQ1Qsa0JBQVksSUFBSSxLQUFLLENBQUM7S0FDdkIsTUFBTSxJQUFJLE9BQU8sRUFBRTtBQUNsQixrQkFBWSxJQUFJLEtBQUssQ0FBQztLQUN2QixNQUFNO0FBQ0wsVUFBSSxNQUFNLEdBQUcsQ0FBQyxFQUFFOzs7Ozs7QUFNZCxzQkFBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztPQUM1QyxNQUFNLElBQUksTUFBTSxHQUFHLENBQUMsRUFBRTtBQUNyQixzQkFBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQztPQUN2QztBQUNELGtCQUFZLElBQUksS0FBSyxDQUFDO0FBQ3RCLGtCQUFZLElBQUksS0FBSyxDQUFDO0tBQ3ZCO0dBQ0Y7O0FBRUQsU0FBTztBQUNMLGtCQUFjLEVBQWQsY0FBYztBQUNkLGtCQUFjLEVBQWQsY0FBYztHQUNmLENBQUM7Q0FDSDs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsYUFBVyxFQUFYLFdBQVc7Q0FDWixDQUFDIiwiZmlsZSI6Ii9ob21lL3dpbGxpYW0vLmF0b20vcGFja2FnZXMvZ2l0LXRpbWUtbWFjaGluZS9ub2RlX21vZHVsZXMvc3BsaXQtZGlmZi9saWIvc3BsaXQtZGlmZi1jb21wdXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG5cbnR5cGUgVGV4dERpZmYgPSB7XG4gIGFkZGVkTGluZXM6IEFycmF5PG51bWJlcj47XG4gIHJlbW92ZWRMaW5lczogQXJyYXk8bnVtYmVyPjtcbiAgb2xkTGluZU9mZnNldHM6IHtbbGluZU51bWJlcjogc3RyaW5nXTogbnVtYmVyfTtcbiAgbmV3TGluZU9mZnNldHM6IHtbbGluZU51bWJlcjogc3RyaW5nXTogbnVtYmVyfTtcbn07XG5cbnR5cGUgRGlmZkNodW5rID0ge1xuICBhZGRlZExpbmVzOiBBcnJheTxudW1iZXI+O1xuICByZW1vdmVkTGluZXM6IEFycmF5PG51bWJlcj47XG4gIGNodW5rczogQXJyYXk8YW55Pjtcbn07XG5cbmZ1bmN0aW9uIGNvbXB1dGVEaWZmKG9sZFRleHQ6IHN0cmluZywgbmV3VGV4dDogc3RyaW5nLCBpc1doaXRlc3BhY2VJZ25vcmVkOiBib29sZWFuKTogVGV4dERpZmYge1xuICB2YXIge2FkZGVkTGluZXMsIHJlbW92ZWRMaW5lcywgY2h1bmtzfSA9IF9jb21wdXRlRGlmZkNodW5rcyhvbGRUZXh0LCBuZXdUZXh0LCBpc1doaXRlc3BhY2VJZ25vcmVkKTtcbiAgdmFyIHtvbGRMaW5lT2Zmc2V0cywgbmV3TGluZU9mZnNldHN9ID0gX2NvbXB1dGVPZmZzZXRzKGNodW5rcyk7XG5cbiAgcmV0dXJuIHtcbiAgICBhZGRlZExpbmVzLFxuICAgIHJlbW92ZWRMaW5lcyxcbiAgICBvbGRMaW5lT2Zmc2V0cyxcbiAgICBuZXdMaW5lT2Zmc2V0cyxcbiAgICBjaHVua3MsXG4gIH07XG59XG5cbmZ1bmN0aW9uIF9jb21wdXRlRGlmZkNodW5rcyhvbGRUZXh0OiBzdHJpbmcsIG5ld1RleHQ6IHN0cmluZywgaXNXaGl0ZXNwYWNlSWdub3JlZDogYm9vbGVhbik6IERpZmZDaHVuayB7XG5cbiAgdmFyIEpzRGlmZiA9IHJlcXVpcmUoJ2RpZmYnKTtcblxuICAvLyBJZiB0aGUgbGFzdCBsaW5lIGhhcyBjaGFuZ2VzLCBKc0RpZmYgZG9lc24ndCByZXR1cm4gdGhhdC5cbiAgLy8gR2VuZXJhbGx5LCBjb250ZW50IHdpdGggbmV3IGxpbmUgZW5kaW5nIGFyZSBlYXNpZXIgdG8gY2FsY3VsYXRlIG9mZnNldHMgZm9yLlxuICBpZiAob2xkVGV4dFtvbGRUZXh0Lmxlbmd0aCAtIDFdICE9PSAnXFxuJyB8fCBuZXdUZXh0W25ld1RleHQubGVuZ3RoIC0gMV0gIT09ICdcXG4nKSB7XG4gICAgb2xkVGV4dCArPSAnXFxuJztcbiAgICBuZXdUZXh0ICs9ICdcXG4nO1xuICB9XG5cbiAgdmFyIGxpbmVEaWZmID0gSnNEaWZmLmRpZmZMaW5lcyhvbGRUZXh0LCBuZXdUZXh0LCB7aWdub3JlV2hpdGVzcGFjZTogaXNXaGl0ZXNwYWNlSWdub3JlZH0pO1xuICB2YXIgY2h1bmtzID0gW107XG5cbiAgdmFyIGFkZGVkQ291bnQgPSAwO1xuICB2YXIgcmVtb3ZlZENvdW50ID0gMDtcbiAgdmFyIG5leHRPZmZzZXQgPSAwO1xuICB2YXIgb2Zmc2V0ID0gMDtcblxuICB2YXIgYWRkZWRMaW5lcyA9IFtdO1xuICB2YXIgcmVtb3ZlZExpbmVzID0gW107XG4gIGxpbmVEaWZmLmZvckVhY2gocGFydCA9PiB7XG4gICAgdmFyIHthZGRlZCwgcmVtb3ZlZCwgdmFsdWV9ID0gcGFydDtcbiAgICB2YXIgY291bnQgPSB2YWx1ZS5zcGxpdCgnXFxuJykubGVuZ3RoIC0gMTtcbiAgICBpZiAoIWFkZGVkICYmICFyZW1vdmVkKSB7XG4gICAgICBhZGRlZENvdW50ICs9IGNvdW50O1xuICAgICAgcmVtb3ZlZENvdW50ICs9IGNvdW50O1xuICAgICAgb2Zmc2V0ID0gbmV4dE9mZnNldDtcbiAgICAgIG5leHRPZmZzZXQgPSAwO1xuICAgIH0gZWxzZSBpZiAoYWRkZWQpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICBhZGRlZExpbmVzLnB1c2goYWRkZWRDb3VudCArIGkpO1xuICAgICAgfVxuICAgICAgYWRkZWRDb3VudCArPSBjb3VudDtcbiAgICAgIG5leHRPZmZzZXQgKz0gY291bnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICByZW1vdmVkTGluZXMucHVzaChyZW1vdmVkQ291bnQgKyBpKTtcbiAgICAgIH1cbiAgICAgIHJlbW92ZWRDb3VudCArPSBjb3VudDtcbiAgICAgIG5leHRPZmZzZXQgLT0gY291bnQ7XG4gICAgfVxuICAgIGNodW5rcy5wdXNoKHthZGRlZCwgcmVtb3ZlZCwgdmFsdWUsIGNvdW50LCBvZmZzZXR9KTtcbiAgICBvZmZzZXQgPSAwO1xuICB9KTtcbiAgcmV0dXJuIHthZGRlZExpbmVzLCByZW1vdmVkTGluZXMsIGNodW5rc307XG59XG5cbmZ1bmN0aW9uIF9jb21wdXRlT2Zmc2V0cyhkaWZmQ2h1bmtzOiBBcnJheTxhbnk+KToge29sZExpbmVPZmZzZXRzOiBhbnk7IG5ld0xpbmVPZmZzZXRzOiBhbnk7fSB7XG4gIHZhciBuZXdMaW5lT2Zmc2V0cyA9IHt9O1xuICB2YXIgb2xkTGluZU9mZnNldHMgPSB7fTtcblxuICB2YXIgb2xkTGluZUNvdW50ID0gMDtcbiAgdmFyIG5ld0xpbmVDb3VudCA9IDA7XG5cbiAgZm9yICh2YXIgY2h1bmsgb2YgZGlmZkNodW5rcykge1xuICAgIHZhciB7YWRkZWQsIHJlbW92ZWQsIG9mZnNldCwgY291bnR9ID0gY2h1bms7XG4gICAgaWYgKGFkZGVkKSB7XG4gICAgICBuZXdMaW5lQ291bnQgKz0gY291bnQ7XG4gICAgfSBlbHNlIGlmIChyZW1vdmVkKSB7XG4gICAgICBvbGRMaW5lQ291bnQgKz0gY291bnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvZmZzZXQgPCAwKSB7XG4gICAgICAgIC8vIE5vbiB6ZXJvIG9mZnNldCBpbXBsaWVzIHRoaXMgYmxvY2sgaXMgbmVpdGhlciBhIHJlbW92YWwgb3IgYW4gYWRkaXRpb24sXG4gICAgICAgIC8vIGFuZCBpcyB0aHVzIGVxdWFsIGluIGJvdGggdmVyc2lvbnMgb2YgdGhlIGRvY3VtZW50LlxuICAgICAgICAvLyBTaWduIG9mIG9mZnNldCBpbmRpY2F0ZXMgd2hpY2ggdmVyc2lvbiBvZiBkb2N1bWVudCByZXF1aXJlcyB0aGUgb2Zmc2V0XG4gICAgICAgIC8vIChuZWdhdGl2ZSAtPiBvbGQgdmVyc2lvbiwgcG9zaXRpdmUgLT4gbmV3IHZlcnNpb24pLlxuICAgICAgICAvLyBNYWduaXR1ZGUgb2Ygb2Zmc2V0IGluZGljYXRlcyB0aGUgbnVtYmVyIG9mIGxpbmVzIG9mIG9mZnNldCByZXF1aXJlZCBmb3IgcmVzcGVjdGl2ZSB2ZXJzaW9uLlxuICAgICAgICBuZXdMaW5lT2Zmc2V0c1tuZXdMaW5lQ291bnRdID0gb2Zmc2V0ICogLTE7XG4gICAgICB9IGVsc2UgaWYgKG9mZnNldCA+IDApIHtcbiAgICAgICAgb2xkTGluZU9mZnNldHNbb2xkTGluZUNvdW50XSA9IG9mZnNldDtcbiAgICAgIH1cbiAgICAgIG5ld0xpbmVDb3VudCArPSBjb3VudDtcbiAgICAgIG9sZExpbmVDb3VudCArPSBjb3VudDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIG9sZExpbmVPZmZzZXRzLFxuICAgIG5ld0xpbmVPZmZzZXRzLFxuICB9O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY29tcHV0ZURpZmYsXG59O1xuIl19
//# sourceURL=/home/william/.atom/packages/git-time-machine/node_modules/split-diff/lib/split-diff-compute.js
